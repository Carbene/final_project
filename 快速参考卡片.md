# 快速参考卡片

## 计算系统架构一览

```
┌────────────────────────────────────────────────────────────┐
│              Calculator Subsystem                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 状态机：输入操作码 → 选择模式 → 选择操作数         │  │
│  │        → 维度验证 → 启动计算 → 显示结果            │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│     ┌────────────────────┼────────────────────┐             │
│     │                    │                    │             │
│     ▼                    ▼                    ▼             │
│  ┌─────────┐       ┌──────────┐       ┌──────────┐         │
│  │Selector │       │ Random   │       │  Matrix  │         │
│  │Display  │       │Selector  │       │  Storage │         │
│  │(手动)   │       │(自动)    │       │          │         │
│  └─────────┘       └──────────┘       └──────────┘         │
│     │                    │                    │             │
│     └────────────────────┼────────────────────┘             │
│                          ▼                                  │
│                  ┌──────────────┐                           │
│                  │  ALU / Calc  │                           │
│                  │  算术逻辑    │                           │
│                  └──────────────┘                           │
│                          │                                  │
│                          ▼                                  │
│                  ┌──────────────┐                           │
│                  │   Printer    │                           │
│                  │   显示结果   │                           │
│                  └──────────────┘                           │
└────────────────────────────────────────────────────────────┘
```

## 状态转移速查表

| 当前状态 | 触发条件 | 下一状态 | 备注 |
|---------|---------|---------|------|
| IDLE | enable=1 | WAIT_OP_CODE | 进入计算模式 |
| WAIT_OP_CODE | btn_confirm | WAIT_INPUT_MODE | 确认操作码 |
| WAIT_INPUT_MODE | btn_confirm | OP1_SEL | 选择输入模式 |
| OP1_SEL | - | OP1_WAIT | 启动选择 |
| OP1_WAIT | selector_done/random_sel_done | BRANCH_OP | 收到操作数 |
| BRANCH_OP | OP=单目 | VALIDATION | 无需第二个 |
| BRANCH_OP | OP=双目 | OP2_SEL | 需要第二个 |
| OP2_SEL | - | OP2_WAIT | 启动选择 |
| OP2_WAIT | selector_done/random_sel_done | VALIDATION | 收到操作数 |
| VALIDATION | 维度合法 | EXECUTE | 可以计算 |
| VALIDATION | 维度非法 | ERROR | 返回重试点 |
| EXECUTE | - | EXECUTE_WAIT | 启动计算 |
| EXECUTE_WAIT | done_calculation | PRINT_RESULT | 计算完成 |
| PRINT_RESULT | !print_busy | PRINT_RESULT_WAIT | 启动显示 |
| PRINT_RESULT_WAIT | print_done | DONE | 显示完成 |
| DONE | - | EXIT | 准备退出 |
| ERROR | - | retry_target | 回到之前的选择 |
| EXIT | enable=0 | IDLE | 退出模式 |
| EXIT | btn_restart | OP1_SEL | 重新开始 |

## 操作码对照表

```
操作码  | 符号名称       | 类型 | 说明
--------|----------------|------|-----------------------------------
0001    | OP_ADD         | 双目 | A + B，维度需相同
0010    | OP_MUL         | 双目 | A * B，A的列数=B的行数
0100    | OP_SCALAR      | 单目 | A * scalar，标量需≤9
1000    | OP_TRANSPOSE   | 单目 | A的转置，mxn→nxm
```

## 维度验证规则速查

```
┌─ 加法 (ADD) ────────────────────────────────┐
│ 需求：m_a == m_b && n_a == n_b              │
│ 例：3x4 + 3x4 = 3x4 ✓                       │
│     3x4 + 2x5 = ERROR ✗                     │
└────────────────────────────────────────────┘

┌─ 矩阵乘法 (MUL) ───────────────────────────┐
│ 需求：n_a == m_b                            │
│ 例：3x4 * 4x2 = 3x2 ✓                       │
│     3x4 * 3x2 = ERROR ✗                     │
└────────────────────────────────────────────┘

┌─ 标量乘法 (SCALAR) ────────────────────────┐
│ 需求：scalar ≤ 9                            │
│ 例：3x4 * 5 = 3x4 ✓                         │
│     3x4 * 12 = ERROR ✗                      │
└────────────────────────────────────────────┘

┌─ 转置 (TRANSPOSE) ─────────────────────────┐
│ 需求：无特殊限制                             │
│ 例：3x4 transpose → 4x3 ✓                   │
│     任意 mxn transpose → nxm ✓              │
└────────────────────────────────────────────┘
```

## 随机选择流程简图

```
GEN_RAND_OP1
    │ (LFSR % 25 → 0-24)
    ▼
QUERY_OP1
    │ (查询 info_table[pos*2 +: 2])
    ▼
CHECK_OP1_EXISTS
    ├─ 无元素 ──┐
    │           ├─ (重试 < 50) → GEN_RAND_OP1
    │           │
    │           └─ (重试 ≥ 50) → ERROR
    │
    └─ 有元素 ──→ READ_OP1 → PRINT_OP1 → DONE (单目)
                                    │
                                    └─→ GEN_RAND_OP2 (双目)
                                        │ (重复同上流程)
                                        └─→ 维度检查
```

## 维度与位置对应速查

```
位置 i = (m-1)*5 + (n-1)

位置 → 维度        位置 → 维度        位置 → 维度
0    → 1x1        5    → 2x1        10   → 3x1
1    → 1x2        6    → 2x2        11   → 3x2
2    → 1x3        7    → 2x3        12   → 3x3
3    → 1x4        8    → 2x4        13   → 3x4
4    → 1x5        9    → 2x5        14   → 3x5

15   → 4x1        20   → 5x1
16   → 4x2        21   → 5x2
17   → 4x3        22   → 5x3
18   → 4x4        23   → 5x4
19   → 4x5        24   → 5x5
```

## 错误代码速查

```
错误类型                  | 触发状态      | 处理方式
--------------------------|--------------|---------------------------
selector_error           | OP1_WAIT/     | → ERROR → 回到对应选择状态
                         | OP2_WAIT      |
维度不匹配（加法）       | VALIDATION    | → ERROR → 回到 OP2_SEL
维度不匹配（乘法）       | VALIDATION    | → ERROR → 回到 OP2_SEL
标量超范围               | VALIDATION    | → ERROR → 回到 LOAD_SCALAR_CONFIRM
无有效矩阵（>50次重试）  | CHECK_OP1/2   | → ERROR → IDLE
                         | _EXISTS       |
倒计时超时               | (任何状态)    | → IDLE (强制中断)
```

## 接口信号速查

### 输入信号
```
enable              - 启用计算模块
btn_confirm        - 确认按钮
btn_restart        - 重新开始按钮
sw[7:0]            - 开关输入（操作码、模式、标量值）
selector_done      - 选择完成（selector_display）
selector_error     - 选择错误（selector_display）
random_sel_done    - 随机选择完成（random_selector）
random_sel_error   - 随机选择错误（random_selector）
done_calculation   - 计算完成（ALU）
print_done         - 打印完成（Printer）
timer_done         - 倒计时完成
```

### 输出信号
```
selector_en                - 启用 selector_display
op_code                    - ALU 操作码
start_calculation         - 启动计算
m_a, n_a, matrix_a        - 第一个操作数
m_b, n_b, matrix_b        - 第二个操作数
scalar                     - 标量值
error_calculator          - 错误信号（触发倒计时）
matrix_result_display_start - 启动显示结果
exitable                   - 是否可以退出模式
```

## 常见调试步骤

1. **检查状态机卡在某状态**
   - 确认相关输入信号是否到达
   - 检查触发条件是否满足

2. **维度验证失败**
   - 打印 m_a, n_a, m_b, n_b 的值
   - 对照维度验证规则检查

3. **随机选择失败**
   - 检查 info_table 是否有有效矩阵
   - 确认重试次数是否达到上限

4. **计算未启动**
   - 确认是否进入 EXECUTE 状态
   - 检查 op_code 是否正确设置

5. **显示未出现**
   - 检查是否进入 PRINT_RESULT 状态
   - 确认 print_done 信号是否返回

## 关键参数修改位置

```
parameter MAX_DIM = 3'd5;           // 最大维度（calculator_subsystem.v）
localparam MAX_RETRY = 8'd50;      // 随机选择重试次数（random_selector.v）
localparam MAX_DIM_ASCII = 8'h35;  // 维度 ASCII 码（如需支持更大维度）

// 标量范围检查（在 VALIDATION 中）
if (scalar > 8'd9)
    next_state = ERROR;  // 可改为其他值
```

## 性能指标

| 指标 | 值 | 单位 |
|-----|-----|------|
| 状态转移延迟 | 1 | 个时钟周期 |
| 随机数生成速率 | 1 | 个/时钟周期 |
| 平均选择时间 | 100-300 | 时钟周期 |
| 最坏选择时间 | ~5000 | 时钟周期 |
| 重试上限 | 50 | 次 |

---

**提示**: 保存此文件以便快速查阅！
