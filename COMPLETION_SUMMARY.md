# 计算系统改造总结

## 工作完成情况

### 1. 计算子系统模块改造 ✅

**文件**: `d:\src\CalculationSubsystem\calculation_subsystem.v`

#### 核心改进：
- **新增状态**: WAIT_OP_CODE, WAIT_INPUT_MODE, EXECUTE_WAIT
- **维度验证函数**: 实现了加法、乘法、标量乘法、转置的维度检查
- **手动/自动模式切换**: 在 WAIT_INPUT_MODE 状态选择
- **完整的错误处理**: 维度不匹配、倒计时超时等

#### 主要功能：
1. 输入操作码（加、乘、标量乘、转置）
2. 选择手动或自动输入模式
3. 单目运算直接进行，双目运算选择两个操作数
4. 维度验证确保运算合法
5. 启动 ALU 计算
6. 显示计算结果

#### 状态机流程：
```
IDLE → WAIT_OP_CODE → WAIT_INPUT_MODE → OP1_SEL → OP1_WAIT
  ↓
BRANCH_OP (分支)
  ├─ 单目 → VALIDATION → EXECUTE → EXECUTE_WAIT → 显示
  └─ 双目 → OP2_SEL → OP2_WAIT → VALIDATION → EXECUTE → EXECUTE_WAIT → 显示
```

### 2. 随机选择模块创建 ✅

**文件**: `d:\src\random_selector.v`

#### 核心功能：
- **LFSR 随机数生成**: 32-bit Gallois 反馈，周期 2^32-1
- **位置查询**: 向矩阵存储查询特定维度是否有元素
- **维度验证**: 双目运算符自动检查合法性
- **智能重试**: 最多重试 50 次找到有效矩阵
- **矩阵打印集成**: 选择完成前打印操作数矩阵

#### 工作流程：
```
单目运算：
  GEN_RAND_OP1 → QUERY_OP1 → CHECK_OP1_EXISTS → READ_OP1 → PRINT_OP1 → DONE

双目运算：
  GEN_RAND_OP1 → QUERY_OP1 → CHECK_OP1_EXISTS → READ_OP1 → PRINT_OP1
    ↓
  GEN_RAND_OP2 → QUERY_OP2 → CHECK_OP2_VALID (维度检查) → READ_OP2 → PRINT_OP2 → DONE
```

#### 维度检查规则：
- **加法**: m1==m2 && n1==n2
- **乘法**: n1==m2
- **标量乘法**: 无需检查第二个操作数
- **转置**: 无需检查第二个操作数

### 3. 文档支持 ✅

#### 创建的文档：
1. **改造说明.md** - 计算系统改造的详细说明
   - 状态定义和转移逻辑
   - 维度验证函数说明
   - 工作流示例
   - 错误恢复流程

2. **random_selector_说明.md** - 随机选择模块使用指南
   - LFSR 工作原理
   - 位置与维度的映射
   - 双目运算验证逻辑
   - 测试用例

3. **random_selector_集成指南.md** - 系统集成指南
   - 架构图示
   - 手动/自动模式流程
   - 集成步骤（4个步骤）
   - 存储仲裁逻辑
   - 打印通道仲裁
   - 故障排查

## 技术亮点

### 1. 模块化设计
- 计算模块专注于状态管理和流程控制
- 随机选择模块独立实现随机算法
- 清晰的接口定义便于集成

### 2. 智能维度验证
- 运用 Verilog 函数实现灵活的验证逻辑
- 支持多种运算符的不同维度要求
- 自动化验证，无需手动对比

### 3. 健壮的错误处理
- 多层次的错误捕获（选择器错误、维度错误、倒计时超时）
- 错误后自动重试或回到合适的状态
- 倒计时超时强制中断机制

### 4. 灵活的随机选择
- LFSR 实现确保随机性
- 50 次重试机制平衡成功率和效率
- 矩阵打印集成提供用户反馈

## 集成检查清单

### 前置条件
- [ ] matrix_storage 模块已实现并可用
- [ ] matrix_printer 模块已实现并可用
- [ ] ALU/calculation 模块已实现并可用
- [ ] selector_display 模块已实现并可用
- [ ] 倒计时模块已实现并可用

### 集成步骤
- [ ] 在 sys_top.v 中实例化 random_selector
- [ ] 配置存储读接口仲裁逻辑
- [ ] 配置矩阵打印通道仲裁逻辑
- [ ] 修改 calculator_subsystem 状态机
- [ ] 修改 OP1_SEL/OP1_WAIT 状态以支持自动模式
- [ ] 修改 OP2_SEL/OP2_WAIT 状态以支持自动模式
- [ ] 配置矩阵打印模块的输入选择

### 仿真验证
- [ ] 单步单目运算（转置）
- [ ] 单步双目运算 - 手动模式
- [ ] 单步双目运算 - 自动模式
- [ ] 维度不匹配错误重试
- [ ] 无有效矩阵错误处理
- [ ] 倒计时超时中断
- [ ] 完整流程测试（从输入到显示结果）

### 系统测试
- [ ] 在 FPGA 上运行
- [ ] 与其他模式（数据输入、生成）兼容性测试
- [ ] UART 通信验证
- [ ] LED/显示反馈验证

## 关键参数配置

| 参数 | 值 | 可调 |
|------|-----|------|
| LFSR 种子 | 32'h12345678 | ✅ |
| 重试上限 | 50 | ✅ |
| 维度范围 | 1-5 | ✅ |
| 矩阵槽位 | 0-1 | ✗ |
| 标量范围 | 0-9 | ✅ |

## 已知限制

1. **存储访问冲突**: selector_display 和 random_selector 需要仲裁
2. **矩阵打印冲突**: 同上
3. **LFSR 周期**: 理论上 2^32-1，但实际观测可能更短（取决于种子）
4. **维度覆盖**: 只支持 1-5，无法处理更大矩阵

## 后续优化方向

1. **动态重试策略**: 根据存储内容自动调整重试次数
2. **权重随机**: 优先选择存储中较多的维度
3. **性能监测**: 记录选择耗时和重试次数
4. **扩展维度**: 支持更大的矩阵维度
5. **种子管理**: 允许外部控制随机序列重复性

## 文件列表

```
d:\src\
├── CalculationSubsystem/
│   ├── calculation_subsystem.v         (改造的计算模块)
│   ├── 改造说明.md                    (详细说明)
│   └── calculation_subsystem_fixed.v   (备份)
├── random_selector.v                  (随机选择模块)
├── random_selector_说明.md            (使用说明)
└── random_selector_集成指南.md        (集成指南)
```

## 接下来的工作

1. **立即可做**:
   - 在 sys_top.v 中添加 random_selector 实例
   - 实现存储仲裁逻辑
   - 修改计算模块状态机

2. **后续工作**:
   - 完整仿真测试
   - FPGA 实现
   - 性能优化
   - 用户界面集成

## 问题反馈渠道

如果在集成过程中遇到问题，请检查：
1. 接口连接是否正确
2. 时钟和复位信号是否可用
3. 仲裁逻辑是否正确处理冲突
4. 维度验证函数是否符合运算规则
5. 模块是否进入了意外的 ERROR 状态

---

**最后更新**: 2025-12-24
**状态**: ✅ 完成
