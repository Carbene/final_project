# 计算子系统模块改造说明

## 概述
该模块已整合 selector_display（矩阵选择显示模块）和 ALU（算术逻辑单元）的功能，实现完整的计算流程管理。

## 主要改进

### 1. 状态机重构
增加了两个新的初始状态，优化了操作流程：

- **WAIT_OP_CODE** (新增): 等待外界输入计算操作码（加法、乘法、标量乘法、转置）
- **WAIT_INPUT_MODE** (新增): 等待外界选择输入模式（手动/自动选择操作数）
- **EXECUTE_WAIT** (新增): 等待 ALU/计算模块完成计算
- **OP1_SEL/OP1_WAIT**: 第一个操作数选择
- **BRANCH_OP**: 根据操作类型分支（单目/双目）
- **OP2_SEL/OP2_WAIT**: 第二个操作数选择（仅双目运算需要）
- **VALIDATION**: 操作数维度验证
- **EXECUTE**: 启动 ALU 计算
- **PRINT_RESULT**: 显示计算结果
- **ERROR**: 错误处理与重试
- **EXIT**: 退出模式

### 2. 维度验证函数

添加了四个验证函数：

```verilog
is_valid_dim(dim)           // 检查维度是否在 1-5 范围内
is_valid_add(m_a,n_a,m_b,n_b)    // 验证加法：m_a==m_b && n_a==n_b
is_valid_mul(m_a,n_a,m_b,n_b)    // 验证乘法：n_a==m_b
is_valid_scalar(m_a,n_a,scalar)  // 验证标量乘法和维度
is_valid_transpose(m_a,n_a)      // 验证转置维度
```

这些函数在 VALIDATION 状态中自动进行检查，**无需手动对比维度**。

### 3. 操作类型处理逻辑

#### 单目运算（转置、标量乘法）
```
WAIT_OP_CODE → WAIT_INPUT_MODE → OP1_SEL → OP1_WAIT 
→ BRANCH_OP → (转置) → VALIDATION → EXECUTE
                   ↓
                (标量乘法) → LOAD_SCALAR_CONFIRM → LOAD_SCALAR → VALIDATION → EXECUTE
```

#### 双目运算 - 手动模式（加法、乘法）
```
WAIT_OP_CODE → WAIT_INPUT_MODE → OP1_SEL → OP1_WAIT 
→ BRANCH_OP → OP2_SEL → OP2_WAIT → VALIDATION → EXECUTE
```

#### 双目运算 - 自动模式
```
WAIT_OP_CODE → WAIT_INPUT_MODE → OP1_SEL → OP1_WAIT 
→ BRANCH_OP → VALIDATION → EXECUTE
```

### 4. 错误处理机制

- **维度错误**: 在 VALIDATION 状态检测，进入 ERROR 状态
- **选择器错误**: selector_error 信号直接触发 ERROR 状态
- **倒计时**: timer_done 边沿检测，超时时强制回到 IDLE
- **重试**: ERROR 状态转移到 retry_target（记录的前一个选择状态）

### 5. 接口整合

#### 与 selector_display 通信
- `selector_en`: 启用选择器
- `selector_done`: 选择完成
- `selector_error`: 选择错误
- `dim_m, dim_n`: 选择的矩阵维度
- `matrix`: 选择的矩阵数据（200 bit）

#### 与 ALU 通信
- `op_code`: 操作码（转置/加法/标量乘法/矩阵乘法）
- `start_calculation`: 启动计算
- `done_calculation`: 计算完成
- `m_a, n_a, matrix_a_flat`: 第一个操作数
- `m_b, n_b, matrix_b_flat`: 第二个操作数
- `scalar`: 标量值（标量乘法用）
- `result_flat, result_m, result_n`: 计算结果

#### 与倒计时通信
- `error_calculator`: 错误信号（触发倒计时）
- `timer_done`: 倒计时完成

## 输入接口详解

### 开关输入 (sw[7:0])

#### 操作码输入 (sw[3:0])
- `4'b0001` (4'd1): 加法
- `4'b0010` (4'd2): 矩阵乘法
- `4'b0100` (4'd4): 标量乘法
- `4'b1000` (4'd8): 转置

#### 输入模式选择 (sw[5])
- `1'b1`: 手动选择操作数
- `1'b0`: 自动模式（仅第一个操作数）

#### 标量值输入 (sw[3:0])
- 范围：0-9（对应 1-9 的倍数）

## 工作流示例

### 例子1：用户选择 2×3 矩阵加 2×3 矩阵（手动模式）

```
1. sw[3:0] = 0001 (加法), btn_confirm → OP_ADD
2. sw[5] = 1 (手动), btn_confirm → 进入操作数选择
3. selector 界面：用户选择第一个 2×3 矩阵 → m_a=2, n_a=3
4. selector 界面：用户选择第二个 2×3 矩阵 → m_b=2, n_b=3
5. VALIDATION: 验证 2==2 && 3==3 ✓
6. EXECUTE: 启动 ALU 执行加法
7. 计算完成后显示结果
```

### 例子2：矩阵 3×2 乘以 2×4 矩阵（自动模式）

```
1. sw[3:0] = 0010 (乘法), btn_confirm → OP_MUL
2. sw[5] = 0 (自动), btn_confirm → 进入自动模式
3. selector 界面：用户选择操作数 3×2 → m_a=3, n_a=2
4. BRANCH_OP: 检测到乘法+自动模式，跳过第二个选择
5. VALIDATION: 需要 n_a == m_b (即 2 == m_b)
6. 如果 m_b ≠ 2 → ERROR，重新回到 OP1_SEL
7. 如果 m_b == 2 → 进入 EXECUTE
```

### 例子3：矩阵标量乘法 3×4 * 5（手动输入标量）

```
1. sw[3:0] = 0100 (标量乘法), btn_confirm → OP_SCALAR
2. (不需要选择输入模式，标量乘法只需一个操作数)
3. selector 界面：用户选择 3×4 矩阵 → m_a=3, n_a=4
4. LOAD_SCALAR_CONFIRM: 等待用户确认
5. sw[3:0] = 5, btn_confirm → 加载标量值 5
6. VALIDATION: 验证 3 ∈ [1,5] && 4 ∈ [1,5] && 5 ≤ 9 ✓
7. EXECUTE: 启动 ALU 执行标量乘法
```

## 错误恢复流程

### 维度不匹配错误
```
OP1_WAIT (selector_done) 
  → m_a=2, n_a=3 (锁存)
  → BRANCH_OP
  → OP2_SEL
  → OP2_WAIT (selector_done)
  → m_b=3, n_b=3 (锁存)
  → VALIDATION: 检测 2 ≠ 3 → ERROR
  → retry_target = OP2_SEL (前一个选择)
  → 回到 OP2_SEL，用户重新选择
```

### selector 错误
```
OP1_WAIT (selector_error) 
  → ERROR
  → retry_target = OP1_SEL
  → 回到 OP1_SEL，用户重新选择
```

### 倒计时超时
```
任何状态下，若 timer_done 边沿到达
  → 强制转移到 IDLE
  → 计算模式完全终止
```

## 关键改变点

| 原模块 | 改造后 | 说明 |
|-------|--------|------|
| WAIT_MODE | WAIT_OP_CODE + WAIT_INPUT_MODE | 分离操作码和模式选择 |
| MODE_TRANS | OP_TRANSPOSE | 统一命名 |
| 直接比对维度 | is_valid_* 函数 | 使用函数自动验证 |
| error 信号 | error_calculator | 更清晰的命名 |
| start 信号 | start_calculation | 更清晰的命名 |
| done 信号 | done_calculation | 更清晰的命名 |
| busy 信号 | busy_calculation | 更清晰的命名 |
| 缺少 EXECUTE_WAIT | 新增 EXECUTE_WAIT | 正确等待计算完成 |

## 后续微调建议

1. **手动/自动模式判断**: 目前使用 sw[5]，可改为按钮或其他输入
2. **标量范围**: 目前限制在 0-9，可根据需求调整
3. **错误处理详细度**: 可添加具体错误码（维度越界、运算不兼容等）
4. **显示信息**: 可添加运算进度显示或中间结果显示

## 测试清单

- [ ] 单目运算（转置）流程
- [ ] 单目运算（标量乘法）流程
- [ ] 双目运算 - 手动模式
- [ ] 双目运算 - 自动模式
- [ ] 维度不匹配错误重试
- [ ] selector 错误处理
- [ ] 倒计时超时中断
- [ ] 计算结果显示
